<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>è£å‚™åƒ¹å€¼è¨ˆç®—å™¨ï¼ˆæ¨™ç±¤ï¼‹åˆ†é ï¼‹æœå°‹ï¼‹æ¨™ç±¤ç¯©é¸ï¼‹JSåŒ¯å‡º/åŒ¯å…¥ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  background:#121212;
  color:#eee;
  font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  margin:0;
  padding:0;
}
h1{
  text-align:center;
  color:#80cbc4;
  margin:10px 0 6px;
}
h2{
  color:#b2dfdb;
  margin:6px 0;
}
h3{
  color:#b2dfdb;
  margin:6px 0;
  font-size:0.95rem;
}
.app-shell{
  display:grid;
  grid-template-columns:220px minmax(0,1fr);
  min-height:calc(100vh - 40px);
  padding:10px 10px 20px;
  gap:10px;
}
@media(max-width:900px){
  .app-shell{
    grid-template-columns:1fr;
  }
}
.sidebar{
  background:#1b1b1b;
  border-radius:10px;
  padding:10px;
  box-shadow:0 0 0 1px #262626;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.sidebar-title{
  font-size:0.9rem;
  color:#b0bec5;
  margin-bottom:4px;
}
.nav-btn{
  width:100%;
  text-align:left;
  border-radius:8px;
  border:1px solid #333;
  background:#101010;
  color:#eee;
  padding:6px 8px;
  font-size:0.86rem;
  cursor:pointer;
}
.nav-btn.active{
  background:#3949ab;
  border-color:#5c6bc0;
}
.nav-btn:hover{
  background:#2b2b2b;
}
.side-section-title{
  margin-top:10px;
  font-size:0.84rem;
  color:#90a4ae;
}
.small{
  font-size:.78rem;
  color:#bbb;
}
.main{
  min-width:0;
}
.card{
  background:#1e1e1e;
  border-radius:10px;
  padding:12px;
  box-shadow:0 0 0 1px #262626;
  margin-bottom:10px;
}
.container-2col{
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1.3fr);
  gap:12px;
}
@media(max-width:900px){
  .container-2col{
    grid-template-columns:1fr;
  }
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:.85rem;
}
th,td{
  border-bottom:1px solid #333;
  padding:4px;
  vertical-align:top;
}
th{
  background:#202020;
}
input,button,select{
  background:#101010;
  color:#eee;
  border:1px solid #444;
  border-radius:6px;
  padding:4px;
  font-size:.82rem;
}
button{
  cursor:pointer;
}
button:hover{
  background:#2b2b2b;
}
.right{text-align:right;}
.good{color:#7fe07f;font-weight:600;}
.bad{color:#ff8a80;font-weight:600;}
.flex{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
  margin:6px 0;
}
.tag{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  background:#263238;
  color:#b0bec5;
  font-size:.7rem;
  margin:2px 4px 2px 0;
}
.tag-row{margin-top:2px;}
.tag-filter{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  background:#263238;
  color:#b0bec5;
  font-size:.7rem;
  margin:2px 4px 2px 0;
  cursor:pointer;
}
.tag-filter.selected{
  background:#ffb300;
  color:#000;
}
.attrtext{color:#b0bec5;font-size:.8rem;}
.search-input{
  width:100%;
}
.hidden{display:none;}
</style>
</head>
<body>

<h1>è£å‚™åƒ¹å€¼è¨ˆç®—å™¨</h1>

<div class="app-shell">
  <div class="sidebar">
    <div class="sidebar-title">é é¢åˆ‡æ›</div>
    <button type="button" class="nav-btn active" id="navEdit" onclick="showPage('edit')">åŸºç¤ & ç•¶å‰è£å‚™</button>
    <button type="button" class="nav-btn" id="navList" onclick="showPage('list')">è£å‚™åˆ—è¡¨</button>

    <div class="side-section-title">è³‡æ–™å­˜å–</div>
    <button type="button" class="nav-btn" onclick="exportToJS()">â¬‡ åŒ¯å‡º JS æª”</button>
    <label class="nav-btn" style="display:block;position:relative;overflow:hidden;">
      â¬† åŒ¯å…¥ JS / JSON
      <input id="importFile" type="file" accept=".js,.json" style="position:absolute;opacity:0;left:0;top:0;width:100%;height:100%;cursor:pointer;" onchange="importFromFile(this)">
    </label>
    <div class="small">
      åŒ¯å‡ºæœƒç”¢ç”Ÿä¸€å€‹ <code>equip_data.js</code>ï¼Œä¸‹æ¬¡å¯åœ¨é€™è£¡åŒ¯å…¥ï¼Œæ¢å¾©åŸºç¤å±¬æ€§ / æ¨™ç±¤ / è£å‚™åˆ—è¡¨è¨­å®šã€‚
    </div>
  </div>

  <div class="main">
    <!-- Page: ç·¨è¼¯åŸºç¤ / ç•¶å‰è£å‚™ -->
    <div id="page-edit">
      <div class="container-2col">
        <!-- å·¦ï¼šåŸºç¤å±¬æ€§ & æ¨™ç±¤ -->
        <div class="card">
          <h2>ä¸€ã€åŸºç¤å±¬æ€§</h2>
          <table>
            <thead>
              <tr><th>å±¬æ€§åç¨±</th><th>åŸºæº–æ•¸å€¼</th><th>åŸºæº–åƒ¹æ ¼</th><th></th></tr>
            </thead>
            <tbody id="baseBody"></tbody>
          </table>
          <div class="flex">
            <button type="button" onclick="addBase()">ï¼‹ æ–°å¢åŸºç¤å±¬æ€§</button>
            <button type="button" onclick="updateAll()">ğŸ”„ æ›´æ–°è¨ˆç®—</button>
          </div>

          <h2 style="margin-top:10px">å±¬æ€§å–®åƒ¹</h2>
          <table>
            <thead><tr><th>å±¬æ€§</th><th class="right">å–®åƒ¹</th></tr></thead>
            <tbody id="unitBody"></tbody>
          </table>

          <h2 style="margin-top:10px">æ¨™ç±¤åˆ—è¡¨</h2>
          <p class="small">
            åŸºç¤å±¬æ€§çš„ã€Œå±¬æ€§åç¨±ã€æœƒè‡ªå‹•è®Šæˆæ¨™ç±¤ã€‚<br>
            ä½ ä¹Ÿå¯ä»¥åœ¨ä¸‹é¢é¡å¤–æ–°å¢è‡ªè¨‚æ¨™ç±¤ï¼ˆä¾‹å¦‚ï¼šç¥è©±ã€ç©¿ç”²ã€æš´æ“Šï¼‰ã€‚
          </p>
          <div id="tagList" class="tag-row"></div>
          <div class="flex">
            <input id="newTagInput" placeholder="æ–°å¢æ¨™ç±¤åç¨±" style="flex:1">
            <button type="button" onclick="addManualTag()">ï¼‹ æ–°å¢æ¨™ç±¤</button>
          </div>
        </div>

        <!-- å³ï¼šç•¶å‰è£å‚™ -->
        <div class="card">
          <h2>äºŒã€ç•¶å‰è£å‚™</h2>

          <div class="flex">
            <span>åç¨±ï¼š</span>
            <input id="equipName" style="flex:1" placeholder="æ˜Ÿè•">
          </div>
          <div class="flex">
            <span>åƒ¹æ ¼ï¼š</span>
            <input id="equipPrice" type="number" placeholder="2900">
          </div>

          <h3 style="margin-top:8px">è£å‚™æ¨™ç±¤</h3>
          <div class="flex">
            <select id="equipTagSelect" style="flex:1">
              <!-- options å‹•æ…‹ç”¢ç”Ÿ -->
            </select>
            <button type="button" onclick="addTagToCurrent()">ï¼‹ åŠ å…¥æ¨™ç±¤</button>
          </div>
          <div id="equipTagRow" class="tag-row small"></div>

          <h3 style="margin-top:8px">è£å‚™å±¬æ€§ / è¢«å‹•</h3>
          <table>
            <thead><tr><th>å±¬æ€§ / è¢«å‹•</th><th>æ•¸å€¼</th><th></th></tr></thead>
            <tbody id="equipBody"></tbody>
          </table>
          <div class="flex">
            <button type="button" onclick="addEquip()">ï¼‹ æ–°å¢å±¬æ€§</button>
            <button type="button" onclick="updateAll()">ğŸ”„ æ›´æ–°è¨ˆç®—</button>
            <button type="button" onclick="addEquipToList()">ï¼‹ åŠ å…¥è£å‚™åˆ—è¡¨</button>
          </div>

          <h2>ç•¶å‰è¨ˆç®—çµæœ</h2>
          <div id="result" class="small">å°šæœªè¨ˆç®—</div>
        </div>
      </div>
    </div>

    <!-- Page: è£å‚™åˆ—è¡¨ -->
    <div id="page-list" class="hidden">
      <div class="card">
        <h2>è£å‚™åˆ—è¡¨</h2>
        <p class="small">å·¦å´å¯è¼¸å…¥åç¨±é—œéµå­—ï¼Œå³å´å¯é»é¸æ¨™ç±¤ä¾†ç¯©é¸ã€‚</p>
        <div class="flex" style="align-items:flex-start;">
          <div style="flex:1 1 40%;min-width:140px;">
            <input id="equipSearch" class="search-input" placeholder="æœå°‹è£å‚™åç¨±â€¦" oninput="renderEquipList()">
          </div>
          <div id="filterTagRow" style="flex:1 1 60%;min-width:160px;">
            <!-- ç¯©é¸ç”¨æ¨™ç±¤ -->
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>è£å‚™ / æ¨™ç±¤</th>
              <th class="right">åƒ¹æ ¼</th>
              <th class="right">å±¬æ€§åƒ¹å€¼</th>
              <th class="right">æ•ˆç‡</th>
              <th>å±¬æ€§ / è¢«å‹•</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="equipListBody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// é˜²æ­¢æ³¨éŸ³ Enter é€ æˆå¥‡æ€ªè¡Œç‚º
document.addEventListener("keydown", e=>{ if(e.key==="Enter") e.preventDefault(); });

// åˆ†é åˆ‡æ›
function showPage(which){
  const edit = document.getElementById("page-edit");
  const list = document.getElementById("page-list");
  const navEdit = document.getElementById("navEdit");
  const navList = document.getElementById("navList");
  if(which === "edit"){
    edit.classList.remove("hidden");
    list.classList.add("hidden");
    navEdit.classList.add("active");
    navList.classList.remove("active");
  }else{
    edit.classList.add("hidden");
    list.classList.remove("hidden");
    navEdit.classList.remove("active");
    navList.classList.add("active");
  }
}

// è³‡æ–™çµæ§‹
let base=[], equip=[], manualUnits={}, equipList=[], nextId=1;
let manualTags=[];        // é¡å¤–æ¨™ç±¤
let currentEquipTags=[];  // ç•¶å‰è£å‚™å·²é¸æ¨™ç±¤
let selectedFilterTags=[]; // è£å‚™åˆ—è¡¨ç¯©é¸ç”¨æ¨™ç±¤

function addBase(s="",v="",p=""){ base.push({s,v,p}); renderAll(); }
function addEquip(s="",v=""){ equip.push({s,v}); renderAll(); }

function autoUnits(){
  const m={};
  base.forEach(r=>{
    const s=(r.s||"").trim(), v=parseFloat(r.v), p=parseFloat(r.p);
    if(s && !m[s] && v>0 && p>0) m[s]=p/v;
  });
  return m;
}

function unitOf(s,a){ return manualUnits[s]??a[s]??0; }

// æ¨™ç±¤ç›¸é—œ
function getAllTags(){
  const fromBase = base.map(r=>(r.s||"").trim()).filter(Boolean);
  const all = new Set([...fromBase, ...manualTags]);
  return [...all];
}

function addManualTag(){
  const input = document.getElementById("newTagInput");
  const name = input.value.trim();
  if(!name) return;
  if(!manualTags.includes(name)) manualTags.push(name);
  input.value="";
  renderAll();
}

function addTagToCurrent(){
  const sel = document.getElementById("equipTagSelect");
  const val = sel.value;
  if(!val) return;
  if(!currentEquipTags.includes(val)) currentEquipTags.push(val);
  renderEquipTags();
}

function removeTagFromCurrent(tag){
  currentEquipTags = currentEquipTags.filter(t=>t!==tag);
  renderEquipTags();
}

function renderEquipTags(){
  const div = document.getElementById("equipTagRow");
  if(currentEquipTags.length===0){
    div.innerHTML = '<span class="small">ï¼ˆå°šæœªé¸æ“‡æ¨™ç±¤ï¼‰</span>';
    return;
  }
  div.innerHTML = currentEquipTags.map(t =>
    `<span class="tag">${t} <a href="javascript:void(0)" onclick="removeTagFromCurrent('${t.replace(/'/g,"\\'")}')" style="color:#ff8a80;text-decoration:none;">Ã—</a></span>`
  ).join("");
}

// åˆ‡æ›åˆ—è¡¨ç¯©é¸æ¨™ç±¤
function toggleFilterTag(tag){
  const idx = selectedFilterTags.indexOf(tag);
  if(idx === -1) selectedFilterTags.push(tag);
  else selectedFilterTags.splice(idx,1);
  renderEquipList();
}

// è¨ˆç®—ç•¶å‰è£å‚™
function computeCurrent(a){
  const name = document.getElementById("equipName").value || "æœªå‘½åè£å‚™";
  const price = parseFloat(document.getElementById("equipPrice").value);
  let sum=0;
  const attrs=[];
  equip.forEach(r=>{
    const s=(r.s||"").trim();
    const v=parseFloat(r.v)||0;
    if(!s) return;
    sum += unitOf(s,a)*v;
    attrs.push(`${s}:${v}`);
  });
  return {
    name,
    price:!isNaN(price)?price:null,
    sum,
    ratio:price?sum/price:null,
    attrText:attrs.join("ã€"),
    tags:[...currentEquipTags]
  };
}

function updateAll(){ renderAll(); }

function renderAll(){
  const a = autoUnits();
  const allTags = getAllTags();

  // åŸºç¤å±¬æ€§è¡¨
  baseBody.innerHTML = "";
  base.forEach((r,i)=>{
    baseBody.innerHTML += `
<tr>
  <td><input value="${r.s}" oninput="base[${i}].s=this.value"></td>
  <td><input type="number" value="${r.v}" oninput="base[${i}].v=this.value"></td>
  <td><input type="number" value="${r.p}" oninput="base[${i}].p=this.value"></td>
  <td><button type="button" onclick="base.splice(${i},1);renderAll()">âœ•</button></td>
</tr>`;
  });

  // å–®åƒ¹è¡¨
  unitBody.innerHTML = "";
  [...new Set([...Object.keys(a), ...Object.keys(manualUnits), ...equip.map(e=>e.s).filter(Boolean)])]
    .forEach(s=>{
      unitBody.innerHTML += `
<tr data-s="${s}">
  <td>${s}</td>
  <td class="right">${unitOf(s,a).toFixed(2)}</td>
</tr>`;
    });

  // æ¨™ç±¤åˆ—è¡¨ï¼ˆå·¦é å±•ç¤ºç”¨ï¼‰
  const tagDiv = document.getElementById("tagList");
  if(allTags.length===0){
    tagDiv.innerHTML = '<span class="small">ç›®å‰æ²’æœ‰ä»»ä½•æ¨™ç±¤ã€‚</span>';
  }else{
    tagDiv.innerHTML = allTags.map(t=>`<span class="tag">${t}</span>`).join("");
  }

  // è£å‚™æ¨™ç±¤ä¸‹æ‹‰
  const sel = document.getElementById("equipTagSelect");
  sel.innerHTML = '<option value="">é¸æ“‡æ¨™ç±¤...</option>' +
    allTags.map(t=>`<option value="${t}">${t}</option>`).join("");

  // è£å‚™å±¬æ€§è¡¨
  equipBody.innerHTML = "";
  equip.forEach((r,i)=>{
    equipBody.innerHTML += `
<tr>
  <td><input value="${r.s}" oninput="equip[${i}].s=this.value"></td>
  <td><input type="number" value="${r.v}" oninput="equip[${i}].v=this.value"></td>
  <td><button type="button" onclick="equip.splice(${i},1);renderAll()">âœ•</button></td>
</tr>`;
  });

  // ç•¶å‰è£å‚™çµæœ
  const c = computeCurrent(a);
  const res = document.getElementById("result");
  let html = `å±¬æ€§åƒ¹å€¼ï¼š${c.sum.toFixed(1)}`;
  if(c.price!=null){
    html += `<br>æ•ˆç‡ï¼š${(c.ratio*100).toFixed(1)}%`;
  }
  res.innerHTML = html;

  // ç•¶å‰è£å‚™æ¨™ç±¤é¡¯ç¤º
  renderEquipTags();

  // è£å‚™åˆ—è¡¨ï¼ˆå«æ¨™ç±¤ç¯©é¸é¡¯ç¤ºï¼‰
  renderEquipList();
}

// æ–°å¢è£å‚™åˆ°åˆ—è¡¨
function addEquipToList(){
  const a = autoUnits();
  const c = computeCurrent(a);
  if(!c.attrText){
    alert("è«‹å…ˆè¼¸å…¥è£å‚™å±¬æ€§");
    return;
  }
  equipList.push({id:nextId++, ...c});
  renderEquipList();
}

// æ¸²æŸ“è£å‚™åˆ—è¡¨ï¼ˆæ”¯æ´åç¨±æœå°‹ï¼‹æ¨™ç±¤ç¯©é¸ï¼‰
function renderEquipList(){
  const tbody = document.getElementById("equipListBody");
  if(!tbody) return;
  const searchInput = document.getElementById("equipSearch");
  const q = searchInput ? searchInput.value.trim().toLowerCase() : "";

  const allTags = getAllTags();
  const filterDiv = document.getElementById("filterTagRow");
  if(filterDiv){
    if(allTags.length===0){
      filterDiv.innerHTML = '<span class="small">ç›®å‰æ²’æœ‰æ¨™ç±¤å¯ä¾›ç¯©é¸ã€‚</span>';
    }else{
      filterDiv.innerHTML = allTags.map(t => {
        const selected = selectedFilterTags.includes(t);
        const safe = t.replace(/'/g,"\\'");
        return `<span class="tag-filter ${selected?'selected':''}" onclick="toggleFilterTag('${safe}')">${t}</span>`;
      }).join("");
    }
  }

  tbody.innerHTML = "";
  equipList.forEach(e=>{
    const nameLower = (e.name||"").toLowerCase();
    if(q && !nameLower.includes(q)) return;

    // è‹¥æœ‰é¸æ“‡æ¨™ç±¤ï¼Œéœ€å…¨éƒ¨ç¬¦åˆï¼ˆAND ç¯©é¸ï¼‰
    if(selectedFilterTags.length){
      const itemTags = e.tags || [];
      const ok = selectedFilterTags.every(t => itemTags.includes(t));
      if(!ok) return;
    }

    const tagHtml = e.tags && e.tags.length
      ? e.tags.map(t=>`<span class="tag">${t}</span>`).join("")
      : '<span class="small">ï¼ˆç„¡æ¨™ç±¤ï¼‰</span>';
    const ratioText = e.ratio ? (e.ratio*100).toFixed(1)+"%" : "-";
    const ratioClass = e.ratio ? (e.ratio>=1?"good":"bad") : "";
    tbody.innerHTML += `
<tr>
  <td>
    <div>${e.name}</div>
    <div class="tag-row">${tagHtml}</div>
  </td>
  <td class="right">${(e.price??0).toFixed(0)}</td>
  <td class="right">${e.sum.toFixed(1)}</td>
  <td class="right"><span class="${ratioClass}">${ratioText}</span></td>
  <td class="attrtext">${e.attrText}</td>
  <td><button type="button" onclick="equipList=equipList.filter(x=>x.id!==${e.id});renderEquipList()">âœ•</button></td>
</tr>`;
  });
}

// å–®åƒ¹å³éµè¨­å®š
unitBody.addEventListener("contextmenu", e=>{
  const tr = e.target.closest("tr"); if(!tr) return;
  e.preventDefault();
  const s = tr.dataset.s;
  const a = autoUnits();
  const cur = manualUnits[s]??unitOf(s,a);
  const v = prompt(`è¨­å®šã€Œ${s}ã€çš„æ¯ 1 å–®ä½é‡‘é¡ï¼ˆç•™ç©ºåˆªé™¤æ‰‹å‹•è¨­å®šï¼‰`, isNaN(cur)?"":cur);
  if(v===null) return;
  const t = v.trim();
  if(!t){ delete manualUnits[s]; }
  else{
    const num = parseFloat(t);
    if(isNaN(num)){ alert("è«‹è¼¸å…¥æ•¸å­—"); return; }
    manualUnits[s]=num;
  }
  renderAll();
});

// åŒ¯å‡ºç‚º JS æª”
function exportToJS(){
  const data = {
    base,
    manualUnits,
    manualTags,
    equipList
  };
  const jsContent = "window.EQUIP_DATA = " + JSON.stringify(data, null, 2) + ";\n";
  const blob = new Blob([jsContent], {type:"application/javascript"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "equip_data.js";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// åŒ¯å…¥ JS / JSON æª”
function importFromFile(input){
  const file = input.files && input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const text = e.target.result || "";
    let loaded = null;
    try{
      // å…ˆå˜—è©¦ç•¶ JSON
      loaded = JSON.parse(text);
    }catch(_){
      try{
        // å†å˜—è©¦ç•¶ JSï¼šæœŸå¾…æœ‰ window.EQUIP_DATA = {...};
        const fn = new Function("let window = {}; " + text + "; return window.EQUIP_DATA || (typeof EQUIP_DATA!=='undefined' ? EQUIP_DATA : null);");
        loaded = fn();
      }catch(err){
        console.error(err);
      }
    }
    if(!loaded){
      alert("ç„¡æ³•è®€å–æª”æ¡ˆå…§å®¹ï¼Œè«‹ç¢ºèªæ˜¯å…ˆå‰åŒ¯å‡ºçš„ JS / JSONã€‚");
      input.value="";
      return;
    }
    // æ‡‰ç”¨è³‡æ–™
    base = Array.isArray(loaded.base)? loaded.base : [];
    manualUnits = loaded.manualUnits || {};
    manualTags = Array.isArray(loaded.manualTags)? loaded.manualTags : [];
    equipList = Array.isArray(loaded.equipList)? loaded.equipList : [];
    // é‡è¨­ç•¶å‰è£å‚™ & æ¨™ç±¤
    equip = [];
    currentEquipTags = [];
    nextId = (equipList.reduce((m,e)=>Math.max(m,e.id||0),0) || 0) + 1;
    input.value="";
    renderAll();
    alert("åŒ¯å…¥å®Œæˆï¼å·²å¥—ç”¨å…ˆå‰çš„å±¬æ€§ / æ¨™ç±¤ / è£å‚™åˆ—è¡¨ã€‚");
  };
  reader.readAsText(file, "utf-8");
}

// åˆå§‹åŒ–
addBase("æ”»æ“ŠåŠ›",10,350);
addEquip();
renderAll();
showPage("edit");
</script>

</body>
</html>
